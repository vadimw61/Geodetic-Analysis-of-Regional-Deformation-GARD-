<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GARD-2025: Advanced Geodetic Platform</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; }
        #sidebar { width: 350px; background: #f8f9fa; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto; }
        #map { flex-grow: 1; }
        h2 { margin-top: 0; color: #2c3e50; font-size: 20px; }
        .control-group { margin-bottom: 15px; background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; }
        input, select { width: 100%; padding: 6px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }

        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 12px; line-height: 1.8; color: #333; }
        .color-scale { width: 180px; height: 14px; background: linear-gradient(to right, #2166ac, #f7f7f7, #b2182b); border: 1px solid #ccc; margin: 4px 0; border-radius: 2px; }
        .scale-labels { display: flex; justify-content: space-between; font-size: 10px; font-weight: bold; }

        /* â”€â”€ ĞŸĞ¾Ğ¿Ğ°Ğ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .leaflet-popup-content-wrapper { width: 340px !important; }
        .popup-title {
            font-size: 15px; font-weight: bold;
            border-bottom: 1px solid #eee; padding-bottom: 6px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .popup-coords {
            font-family: monospace; font-size: 12px;
            background: #f4f4f4; padding: 7px; border-radius: 4px; line-height: 1.8;
        }
        .popup-footer {
            margin-top: 10px; display: flex; gap: 8px;
        }
        .popup-btn {
            flex: 1; padding: 7px 0; border: none; border-radius: 5px;
            font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .popup-btn-detail {
            background: #1d4ed8; color: white;
        }
        .popup-btn-detail:hover { background: #1e40af; }

        #loading { display: none; text-align: center; margin-top: 10px; color: #e67e22; font-weight: bold; }
        .warn-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 7px 10px; font-size: 12px; margin-top: 8px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>ğŸŒ GARD-Analytics Pro</h2>

    <div class="control-group">
        <label>1. Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚Ğµ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ (BBox)</label>
        <input type="text" id="bbox_display" placeholder="ĞĞ°Ñ€Ğ¸ÑÑƒĞ¹Ñ‚Ğµ Ğ¿Ñ€ÑĞ¼Ğ¾ÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸Ğº..." readonly>
    </div>

    <div class="control-group">
        <label>2. ĞœĞ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹</label>

        <label>Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ (0 = Ğ²ÑĞµ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸):</label>
        <input type="number" id="process_limit" value="0" min="0">

        <label>Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ÑĞ¿Ğ¾Ñ…Ğ° (Ğ³Ğ¾Ğ´):</label>
        <input type="number" id="target_epoch" value="2020.0" step="0.1">

        <label>Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ğ¿Ğ¾Ñ€Ğ½Ğ¾Ğ¹ ÑĞµÑ‚Ğ¸ (K-Means ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¾Ğ²):</label>
        <input type="number" id="target_count" value="15" min="3" max="60">

        <label>Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ñ‚ÑÑ‡Ñ‘Ñ‚Ğ° ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ĞµĞ¹:</label>
        <select id="vel_mode" onchange="drawMapLayers()">
            <option value="plate">Plate-Fixed (Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğµ Ğ´ĞµÑ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸)</option>
            <option value="global">IGS20 (Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¸Ğ½ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°)</option>
        </select>
    </div>

    <button id="calc_btn" onclick="runAnalysis()">ğŸš€ Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ</button>
    <div id="loading">
        â³ Ğ˜Ğ´Ñ‘Ñ‚ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·â€¦
        <br><span style="font-size:11px;color:#7f8c8d;">(ĞœĞ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚)</span>
    </div>

    <div class="control-group" id="results_panel" style="display:none; margin-top:15px; background:#e8f8f5;">
        <label>Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:</label>
        <div id="stats" style="font-size:13px; line-height:1.7;"></div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
// â”€â”€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var map = L.map('map').setView([36.0, 138.0], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap & CARTO'
}).addTo(map);

var allStationsLayer = L.featureGroup();
var refNetworkLayer  = L.featureGroup().addTo(map);
var vectorsLayer     = L.featureGroup().addTo(map);
var strainLayer      = L.featureGroup().addTo(map);
var drawnItems       = new L.FeatureGroup().addTo(map);

L.control.layers(null, {
    "Ğ¢ĞµĞ¿Ğ»Ğ¾Ğ²Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ° (Strain)":  strainLayer,
    "Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ° ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ĞµĞ¹":        vectorsLayer,
    "ĞĞ¿Ğ¾Ñ€Ğ½Ğ°Ñ ÑĞµÑ‚ÑŒ (Ğ›ÑƒÑ‡ÑˆĞ¸Ğµ)":    refNetworkLayer,
    "Ğ’ÑĞµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸": allStationsLayer
}, { collapsed: false }).addTo(map);

var drawControl = new L.Control.Draw({
    draw: { polygon:false, marker:false, circle:false, circlemarker:false, polyline:false, rectangle:true },
    edit: { featureGroup: drawnItems }
});
map.addControl(drawControl);

var currentBbox = null;
var currentData = null;

map.on(L.Draw.Event.CREATED, function(e) {
    drawnItems.clearLayers();
    drawnItems.addLayer(e.layer);
    var b = e.layer.getBounds();
    currentBbox = [b.getSouth(), b.getNorth(), b.getWest(), b.getEast()];
    document.getElementById('bbox_display').value = currentBbox.map(x => x.toFixed(2)).join(', ');
});

// â”€â”€ ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openStationDetail(station) {
    // ĞšĞ»Ğ°Ğ´Ñ‘Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² sessionStorage Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ
    const payload = {
        station: station,
        meta:    currentData.meta
    };
    sessionStorage.setItem('jgrf_station_detail', JSON.stringify(payload));
    window.open('/station_detail', '_blank');
}

// â”€â”€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
    if (!currentBbox) { alert("Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ñ‹Ğ´ĞµĞ»Ğ¸Ñ‚Ğµ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ!"); return; }

    document.getElementById('calc_btn').disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('results_panel').style.display = 'none';

    try {
        const resp = await fetch('/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                bbox:          currentBbox,
                count:         document.getElementById('target_count').value,
                epoch:         document.getElementById('target_epoch').value,
                process_limit: document.getElementById('process_limit').value
            })
        });
        const res = await resp.json();
        if (res.status === 'success') {
            currentData = res.data;
            updateStats();
            drawMapLayers();
            updateLegend();
        } else { alert("ĞÑˆĞ¸Ğ±ĞºĞ°: " + res.message); }
    } catch(e) {
        alert("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼.");
    }
    document.getElementById('calc_btn').disabled = false;
    document.getElementById('loading').style.display = 'none';
}

// â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ² ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€Ğµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
    document.getElementById('results_panel').style.display = 'block';
    const m = currentData.meta;
    const p = m.euler_pole;

    let eulerWarn = '';
    if (m.euler_valid === false) {
        eulerWarn = `<div class="warn-box">
            âš ï¸ ĞŸĞ¾Ğ»ÑÑ Ğ­Ğ¹Ğ»ĞµÑ€Ğ° Ğ½ĞµĞ½Ğ°Ğ´Ñ‘Ğ¶ĞµĞ½ â€” Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ¿ĞµÑ€ĞµÑĞµĞºĞ°ĞµÑ‚ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¿Ğ»Ğ¸Ñ‚.
            Plate-Fixed ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹.
        </div>`;
    }

    document.getElementById('stats').innerHTML = `
        <b>ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾:</b> ${m.processed} ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¹<br>
        <b>ĞĞ¿Ğ¾Ñ€Ğ½Ğ°Ñ ÑĞµÑ‚ÑŒ:</b> ${currentData.ref_network_ids.length} ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¹<br>
        <b>Ğ¢Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¾Ğ²:</b> ${currentData.triangles.length}<br>
        <b>Ğ’Ñ€ĞµĞ¼Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ°:</b> ${m.time_sec} ÑĞµĞº<br>
        <b>Ğ¢ĞµĞºÑ‚. Ğ·Ğ¾Ğ½Ğ°:</b> ${m.zone_name}<br>
        <b>Ğ’ĞµĞºÑ‚Ğ¾Ñ€ Ğ­Ğ¹Ğ»ĞµÑ€Ğ° (deg/Myr):</b><br>
        &nbsp; X: ${p[0].toFixed(4)}<br>
        &nbsp; Y: ${p[1].toFixed(4)}<br>
        &nbsp; Z: ${p[2].toFixed(4)}
        ${eulerWarn}
    `;
}

// â”€â”€ Ğ¦Ğ²ĞµÑ‚ Ñ‚Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ° (ÑĞ¸Ğ½Ğ¸Ğ¹=ÑĞ¶Ğ°Ñ‚Ğ¸Ğµ, ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹=Ñ€Ğ°ÑÑ‚ÑĞ¶ĞµĞ½Ğ¸Ğµ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function strainColor(val, sMax) {
    const t = Math.max(-1, Math.min(1, val / Math.max(sMax, 1)));
    if (t >= 0) {
        return `rgba(255,${Math.round(247*(1-t))},${Math.round(247*(1-t))},0.72)`;
    } else {
        return `rgba(${Math.round(247*(1+t))},${Math.round(247*(1+t))},255,0.72)`;
    }
}

// â”€â”€ ĞÑ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° ÑĞ»Ğ¾Ñ‘Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawMapLayers() {
    if (!currentData) return;
    allStationsLayer.clearLayers();
    refNetworkLayer.clearLayers();
    vectorsLayer.clearLayers();
    strainLayer.clearLayers();

    const mode   = document.getElementById('vel_mode').value;
    const refSet = new Set(currentData.ref_network_ids);
    const sMax   = currentData.meta.strain_max;

    // Ğ¢Ñ€ĞµÑƒĞ³Ğ¾Ğ»ÑŒĞ½Ğ¸ĞºĞ¸
    currentData.triangles.forEach(tri => {
        const val = tri.strain;
        L.polygon(tri.coords.map(c => [c[1], c[0]]), {
            color: '#555', weight: 0.4,
            fillColor: strainColor(val, sMax), fillOpacity: 0.72
        })
        .addTo(strainLayer)
        .bindTooltip(`Ğ”Ğ¸Ğ»Ğ°Ñ‚Ğ°Ñ†Ğ¸Ñ: ${val.toFixed(1)} Ğ½ÑÑ‚Ñ€ĞµĞ¹Ğ½/Ğ³Ğ¾Ğ´`);
    });

    // ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ± ÑÑ‚Ñ€ĞµĞ»Ğ¾Ğº
    const velKey_e = mode === 'plate' ? 've_plate' : 've';
    const velKey_n = mode === 'plate' ? 'vn_plate' : 'vn';
    const speeds = currentData.stations
        .map(s => Math.sqrt((s[velKey_e]||0)**2 + (s[velKey_n]||0)**2))
        .filter(v => isFinite(v) && v < 500).sort((a,b) => a-b);
    const p90 = speeds[Math.floor(speeds.length * 0.9)] || 10.0;
    const arrowScale = Math.max(0.001, Math.min(0.05, 0.5 / Math.max(p90, 1)));

    // Ğ¡Ñ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸
    currentData.stations.forEach(s => {
        const isRef  = refSet.has(s.id);
        const isWarn = s.is_precursor;
        const color  = isWarn ? '#e74c3c' : (isRef ? '#2ecc71' : '#3498db');
        const radius = (isRef || isWarn) ? 6 : 4;

        // â”€â”€ ĞŸĞ¾Ğ¿Ğ°Ğ¿: Ğ¿Ñ€ĞµĞ²ÑŒÑ + ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const jumpStr = s.jumps > 0
            ? `<span style="color:#e67e22;">âš¡ Ğ¡ĞºĞ°Ñ‡ĞºĞ¾Ğ²: ${s.jumps}</span>`
            : 'âœ… Ğ¡ĞºĞ°Ñ‡ĞºĞ¾Ğ² Ğ½ĞµÑ‚';
        const epochStr = s.epoch_reliable
            ? 'âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñƒ ÑĞ¿Ğ¾Ñ…Ğ¸'
            : `<span style="color:#e74c3c;">âš ï¸ Ğ­Ğ¿Ğ¾Ñ…Ğ° ÑĞºÑÑ‚Ñ€Ğ°Ğ¿Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°</span>`;

        const popupContent = `
            <div>
                <div class="popup-title">
                    <span>${s.id}</span>
                    <span style="font-size:13px;">${isWarn ? 'âš ï¸' : 'âœ…'}</span>
                </div>
                <div class="popup-coords">
                    Lat: ${s.lat.toFixed(4)}Â°&nbsp;&nbsp;Lon: ${s.lon.toFixed(4)}Â°<br>
                    Ve: ${s.ve.toFixed(1)} Ğ¼Ğ¼/Ğ³&nbsp;&nbsp;Vn: ${s.vn.toFixed(1)} Ğ¼Ğ¼/Ğ³<br>
                    RMSE: ${s.rmse.toFixed(2)} Ğ¼Ğ¼&nbsp;&nbsp;${jumpStr}<br>
                    ${epochStr}
                </div>
                <div id="plot_${s.id}" style="width:100%;height:160px;margin-top:7px;"></div>
                <div class="popup-footer">
                    <button class="popup-btn popup-btn-detail"
                        onclick="openStationDetail(currentData.stations.find(x=>x.id==='${s.id}'))">
                        ğŸ“Š ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ â†’
                    </button>
                </div>
            </div>
        `;

        const marker = L.circleMarker([s.lat, s.lon], {
            color: '#333', weight: 1,
            fillColor: color, fillOpacity: 0.9, radius: radius
        });

        marker.bindPopup(popupContent, { maxWidth: 360 })
              .on('popupopen', function() {
            // ĞŸÑ€ĞµĞ²ÑŒÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ X-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
            Plotly.newPlot(`plot_${s.id}`, [
                { x: s.graph.t, y: s.graph.raw_x, mode: 'markers', name: 'Raw',
                  marker: { size: 2.5, color: '#aaa' } },
                { x: s.graph.t, y: s.graph.filt_x, mode: 'lines', name: 'EKF',
                  line: { color: '#2980b9', width: 1.8 } }
            ], {
                margin: { l:40, r:8, t:6, b:28 },
                showlegend: false,
                yaxis: { title: 'Î”X (Ğ¼)', titlefont:{size:10}, tickfont:{size:9} },
                xaxis: { tickfont:{size:9} },
                paper_bgcolor:'white', plot_bgcolor:'#fafafa'
            }, { displayModeBar: false });
        });

        if (isRef) marker.addTo(refNetworkLayer);
        marker.addTo(allStationsLayer);

        // Ğ¡Ñ‚Ñ€ĞµĞ»ĞºĞ°
        const ve_a = s[velKey_e] || 0;
        const vn_a = s[velKey_n] || 0;
        if (!isFinite(ve_a) || Math.sqrt(ve_a**2+vn_a**2) > 300) return;

        L.polyline(
            [[s.lat, s.lon], [s.lat + vn_a*arrowScale, s.lon + ve_a*arrowScale]],
            { color: '#1a1a1a', weight: 1.8, opacity: 0.85 }
        ).addTo(vectorsLayer)
         .bindTooltip(`${s.id}: Ve=${ve_a.toFixed(1)}, Vn=${vn_a.toFixed(1)} Ğ¼Ğ¼/Ğ³Ğ¾Ğ´`);

        L.circleMarker([s.lat + vn_a*arrowScale, s.lon + ve_a*arrowScale], {
            radius: 2.5, color: '#1a1a1a', fillColor: '#1a1a1a', fillOpacity: 1, weight: 0
        }).addTo(vectorsLayer);
    });
}

// â”€â”€ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var legendControl = L.control({ position: 'bottomright' });
function updateLegend() {
    if (legendControl.getContainer()) map.removeControl(legendControl);
    legendControl.onAdd = function() {
        const div    = L.DomUtil.create('div', 'legend');
        const maxStr = currentData ? currentData.meta.strain_max.toFixed(0) : '100';
        div.innerHTML = `
            <b>Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¸Ğ»Ğ°Ñ‚Ğ°Ñ†Ğ¸Ğ¸ (Ğ½ÑÑ‚Ñ€ĞµĞ¹Ğ½/Ğ³Ğ¾Ğ´)</b><br>
            <div class="scale-labels">
                <span>âˆ’${maxStr} (Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ)</span>
                <span>0</span>
                <span>+${maxStr} (Ğ Ğ°ÑÑ‚ÑĞ¶ĞµĞ½Ğ¸Ğµ)</span>
            </div>
            <div class="color-scale"></div>
            <hr style="margin:6px 0;">
            <b>Ğ¢Ğ¸Ğ¿Ñ‹ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¹:</b><br>
            <span style="color:#2ecc71;font-size:16px;">â—</span> ĞĞ¿Ğ¾Ñ€Ğ½Ğ°Ñ ÑĞµÑ‚ÑŒ (K-Means)<br>
            <span style="color:#3498db;font-size:16px;">â—</span> Ğ ÑĞ´Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ<br>
            <span style="color:#e74c3c;font-size:16px;">â—</span> <b>ĞĞ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ñ / Ğ½ĞµĞ½Ğ°Ğ´Ñ‘Ğ¶Ğ½Ğ°Ñ ÑĞ¿Ğ¾Ñ…Ğ°</b>
        `;
        return div;
    };
    legendControl.addTo(map);
}
updateLegend();
</script>
</body>
</html>
